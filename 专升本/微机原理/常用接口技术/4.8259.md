# 8259

* 中断控制器8259A
* 可编程中断控制器PIC
  * 用于管理intel8086/8088
    * 80286/80386的可屏蔽中断
* 8259A的基本功能
  * 一片8259A可以管理8级中断，可宽展至64级
  * 每一级中断都可单独被屏蔽或允许
  * 在中断响应周期，可提供响应的中断向量号
  * 8259A有多种 工作方式，可通过编程选择
  * ![image-20250404184348586](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404184348586.png)
* 内部寄存器
  * 中断请求寄存器IRR
    * 保存IR0~IR7中断请求状态
  * 中断服务寄存器ISR
    * 保存正在被8259服务的状态
  * 中断屏蔽寄存器IMR
    * 保存对中断请求IR的屏蔽状态
  * 功能
    * 管理8088/8086的可屏蔽中断 一片8259A可管理8级中断，可以多片8259级联(8259A引脚CAS2CAS的功能)，可扩展至64级。(9片可扩展到64级，9*8-8=64，减的8是8个从片占用的引脚数)
    * 每一级中断都可单独被屏蔽或允许
    * 在中断相应周期，可提供相应的中断类型号(向量号)
    * 8259A有多种工作方式，可通过编程选择
* 与处理器接口
  * ![image-20250404184459832](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404184459832.png)
* 中断级联
  * ![image-20250404184538929](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404184538929.png)
  * 8259A可以级连，一个主8259A，若千个(最多8个)从8259A;
  * 级连时，主8259A的CAS0~CAS2为输出线，连至从8259A的CASO~CAS2 从8259A的INT，连主8259A的IR;
  * 主8259A的INT线连至CPU的INTR;
  * SP*/EN在非缓冲方式下，SP\*=1时，8259A是主片SP\*=0时8259A是从片。
  * 8259A的中断过程
    * 请求
    * 判优
    * 响应
    * 处理
    * 返回
  * 8259A的工作方式
    * 中断触发方式
      * 边沿触发方式
      * 电平触发方式
    * 设置优先权方式
      * 完全嵌套方式
      * 自动循环方式
      * 中断屏蔽方式
  * 结束中断处理方式
    * 自动中断结束方式
    * 非自动中断方式
      * 普通中断结束方式
      * 特殊中断结束方式
  * 屏蔽中断源方式
    * 普通屏蔽方式
    * 特殊屏蔽方式
  * 数据线连接方式
    * 缓冲方式
    * 非缓冲方式
  * 8259A的编程
    * 初始化编程
      * 8259A开始工作前，必须进行初始化编程给8259A写入初始化命令字ICW
      * ![image-20250404184837069](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404184837069.png)
      * 初始化命令字ICW
        * 初始化命令字ICW最多有4个
        * 必须按照ICW1~ICW4顺序写入
        * ICW1和ICW2是必须送的
        * ICW3用于级联
        * ICW4用于8088/8086
      * 操作命令字OCW
        * 8259A工作期间，可以接受操作命令字OCW;
        * OCW共有3个:0CW1~0CW3 写入时没有顺序要求，需要哪个OCW就写入那个OCW。 
        * OCW1写入奇地址 
        * OCW2写入偶地址 
        * OCW3写入偶地址
        * 中断屏蔽操作命令字:OCW1:
        * 优先级循环和中断结束命令字:OCW2:
        * 设置特殊屏蔽方式命令字:OCW3: 
        * ICW1:确定触发方式和工作方式 
        * ICW2:确定中断类型 
        * ICW3:确定主片上的信号线连接从片方式
        * ICW4:确定全嵌套方式，缓冲方式、结束方式
        * ![image-20250404185033073](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185033073.png)
        * ![image-20250404185056122](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185056122.png)
        * ![image-20250404185114749](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185114749.png)
        * ![image-20250404185147278](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185147278.png)
        * 8250A的操作命令字
          * 三个操作命令字OCW1~OCW3
          * 在设置操作命令字时，顺序上没有严格的要求，但端口地址上有严格的规定
          * OCW1必须写入奇地址端口（A0=1）
          * OCW2和OCW3必须写入偶地址端口（A0=0）
          * ![image-20250404185232497](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185232497.png)
          * ![image-20250404185246604](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185246604.png)
          * ![image-20250404185301262](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185301262.png)
          * ![image-20250404185316310](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185316310.png)
          * 8259A的工作方式
            * 中断嵌套
              * 全嵌套方式
                * 当工作在全嵌套方式时，8259A写入初始化命令字后，中断优先权是固定的，即IR0优先权最高，IR7优先权最低。当CPU响应中断时，申请中断的优先权最高的是中断源在ISR中响应位置位，而且把它的中断向量号（类型码）送到数据中线，在此中断源的中断服务程序完成前，与它统计或优先权更低的中断源申请被屏蔽，只有优先权比它高的中断源申请才允许
              * 特殊全嵌套方式——级联情况
                * 与全嵌套方式不同之处
                  * 当某一从片中断请求被响应后，主片不封锁从片的INT输入端，使该从片优先级更高的中断源的请求能的到响应
                  * 当从片中断处理快要结束时，用软件检查从片中断服务寄存器ISR的内容是否为0，若为0，则这个从片的中断请求使唯一的，此时连发两个中断结束命令EOI，使主片、从片都结束中断，若只发一个EOI命令则只结束从片，不结束主片中断
            * 中断优先级循环方式
              * 8259A中有两种改变优先权的办法
              * 自动循环方式
                * 当某一个中断源服务完以后，它的优先级变成最低的
              * 特殊循环方式
                * 如果中断源的优先权需要任意改变，就必须工作在特殊循环方式下，此时，可用程序通过写OCW2来改变优先权
            * 中断屏蔽
              * 8259A的8条中断请求线的每一条都可根据需要单独屏蔽，可通过写入OCW1的命令字来实现
              * 普通屏蔽方式
                * 特点
                  * 当执行某一级中断服务程序时，只允许比该优先级高的中断源申请中断，不允许同级或低级的中断源申请中断
                * 方法
                  * 用OCW1将IMR寄存器某一位或几位置1，即可将响应的中断请求屏蔽掉
                * 使用情况
                  * 当CPU执行主程序时，可将不希望响应的中断源屏蔽；当CPU执行某中断服务程序时，可将不希望响应的比此优先级高的中断源屏蔽
              * 特殊屏蔽方式
                * 特点
                  * CPU正在处理某一级中断时，只可对本级中断进行屏蔽，允许级别比它高的或比它低的中断源申请中断
                * 方法
                  * 在某级中断服务程序中首先用OCW3设置该方式（级D6D5=11），然后设置OCW1使该级中断申请被屏蔽，只有写入这两个控制字之后，才能使中断屏蔽寄存器IMR中该级中断位被屏蔽（=1），不允许发生同级中断，同时使用中断服务寄存器ISR相应位置0，允许比该级低级别的中断源申请中断。若想退出此方式，通过设置OCW3的D6D5=10，只执行输出指令即可
                * 使用情况
                  * 在中断处理过程中，需要动态改变系统的优先级结构时
                  * ![image-20250404185553926](E:\study\lianxi\MyLearningDocuments\专升本\images\image-20250404185553926.png)
* 中断结束命令
  * 自动中断结束方式（AEOI）
    * 特点
      * 中断服务寄存器ISR的相应位清零是由硬件自动完成的。当某一级中断被CPU响应后，CPU送回第一个INTA中断响应信号，使ISR的相应位置1，当 第二个INTA负脉冲结束时，自动将ISR的相应位置0
    * 实现方式：通过将ICW4的D1位设置为1实现
    * 使用环境：使用不要求中断嵌套的情况
* 非自动中断结束方式（EOI）
  * 特点
    * 中断返回前，必须用指令向8259A发中断结束命令，即使ICW4的D1=0.若级联，发两个
  * 方法
    * 首先将ICW4的D1=0，定为正常中断结束方式，然后用OUT向8259A的偶地址端口输出OCW2操作控制字（OCW2的D7D6D5=001），实现自动结束命令
  * 使用环境
    * 一般的中断结束方式只能应用 于全嵌套方式下，不能用于优先级自动循环方式和优先级特殊循环方式。因为一般中断结束方式结束的中断时尚未处理完的级别最高的中断，若中断级别改变，会使整个中断过程混乱
* 特殊中断结束方式
  * 特点
    * 通过用指令发一中断结束命令，同时给出结束中断的中断源时哪一级，使该中断源的中断服务寄存器ISR的相应位置0
  * 使用环境：可应用在任何情况下，但要在中断处理给出中断结束命令
  * 使用方法
    * 首先将ICW4的D1=0，定位正常中断结束方式，然后通过将OCW2的D7D6D5=011或111，D2D1D0位指出结束中断处理的中断源号，使该中断源在中断服务寄存器ISR中的相应位清零
* 读8259A的状态
  * 8259A的IRR、ISR、IMR的状态，可通过读命令读入CPU，供用户了解8259A的工作情况。 (1)在读命令之前，输出一个OCW3，令其RR=1，RIS=0(D,Do=10)，可利用读命令读入中断请求寄存器IRR的状态。若RR=1，RIS=1(D,D,=11)，可利用读命令读入中断服务寄存器ISR的状态。 (2)对奇地址端口(A0=1)进行读操作，可读得中断屏蔽寄存器IMR的值。
