# 输入输出系统

* 输入输出（I/O）接口概念

  * 为什么需要I/O接口（电路）？

    * 微机的外部设备多种多样
    * 工作原理、信息格式、工作速度等方面差别很大
    * 外设不能与CPU直接相连
    * 必须经过中间电路在与系统相连，这部分电路被称为I/O接口电路

  * 什么是I/O接口（电路）？

    * I/O接口时位于系统与外设间、用来协作完成数据传送和控制任务的逻辑电路
    * 可编程接口芯片、I/O总线槽的电路板（适配器）都是接口电路

  * I/O接口的主要功能

    * 速度匹配、数据缓冲
    * 数据格式的转换
    * 对I/O端口寻址、地址译码
    * CPU与外设信息联络
    * 设置中断和DMA控制逻辑

  * 端口（PORT）

    * 泛指I/O地址，对应接口电路的寄存器
    * 一个接口电路可以具有多个I/O端口（寄存器）
    * 数据端口、状态端口、控制端口
    * 用于保存数据、状态和控制信息

  * I/O接口结构

    * ![image-20250404163152008](E:\study\lianxi\MyLearningDocuments\images\image-20250404163152008.png)

  * I/O接口组成

    * 接口由硬件和软件组成
    * 接口软件有两类
      * 初始化程序段
        * 设备驱动程序、设定芯片工作方式
      * 数据交换程序段
        * 控制、管理、驱动外设、负责外设和系统间信息交换

  * I/O端口的编址

    * I/O端口泛指I/O地址，对应接口电路的寄存器
    * 一个接口电路可以 具有多个I/O端口（寄存器）数据端口、状态端口、控制端口
    * 8088/8086用于寻址外设端口的地址线为16条
    * 端口最多有：2的十六次方
    * 端口号：0000H~FFFFH
    * 两种编址：独立编址、统一编址
      * I/O端口单独编址
        * I/O地址空间独立于存储地址空间
        * 优点
          * I/O端口的地址空间独立
          * 控制和地址译码电路简单
          * 专门的I/O指令
        * 缺点
          * I/O指令种类少
      * I/O端口与存储器统一编址
        * 他们共享一个地址空间
        * 优点
          * 不需要专门的I/O指令
          * I/O数据存取灵活
        * 缺点
          * I/O端口要占去部分存储器地址空间
          * 程序不易阅读（不容易分清访存储器还是访问外设）

  * I/O端口寻址方式

    * 直接寻址
      * 只寻址00H~FFH前256个端口
      * 指令中操作数直接使用端口号
      * IN AL/AX,端口号
      * OUT 端口号,AL/AX
    * 间接寻址
      * 可寻址端口：0000H~FFFFH
      * DX寄存器的值存放端口号
      * 0100H~FFFFH的端口只能采用间接寻址方式
      * MOV AL/AX, 端口号
      * IN DX，AL/AX
      * MOV DX，端口号
      * OUT DX,AL/AX
  
  * 8259:中断控制器
  
  * 8253：定时计数器
  
  * 8255：可编程的并行接口
  
  * 8251：可编程的串行接口
  
  * 0809：ADC-模拟信号转数字信号
  
  * 0832：DAC-数字信号转模拟信号
  
  * I/O地址的译码
  
    * 门电路：接口电路只占少量I/O地址，可以利用线选法地址译码
    * 译码器：选用2：4或3：8进行地址译码
  
  * 数据传送方式
  
    * 程序控制的数据传送
  
      * cpu执行程序中的I/O指令完成传送，分为无条件传送、查询传送、中断传送。
  
    * 直接存储器存取（DMA）
  
      * DMAC利用系统总线在外设和主存间传送
  
    * I/O处理机实现数据传送
  
      * CPU委托专门的I/O处理机来完成数据传送
  
    * 无条件（同步）传送方式
  
      * 原理
        * CPU与慢速外设交换数据。外设处于就绪状态，随时可以进行数据传送，亦称同步传送。（适合于简设备）
      * 传送条件
        * 外设必须随时就绪
        * 外设已经准备就绪
          * 输入：数据已经放在三态缓冲区中，准备好数据
          * 输出：外设及时从锁存器中取走数据，锁存器为空时CPU再传下一个数据
        * 传送双方已经约定外设在CPU规定的时间内，完成数据的输入/出
  
    * 条件传送控制方式（查询/异步）
  
      * 原理
        * 特点
          * CPU等待外设准备数据或取走数据后进行数据的入/出操作
          * 解决CPU与外设不同步传送数据的问题
          * 在传送数据之前需检测外设状态CPU通过执行主程序中IN/OUT实现数据的输入与输出工作可靠，但传送效率低
        * 过程
          * 查询
            * CPU读取外设状态。用IN AL，port
            * CPU检测状态是否就绪
              * Test AL,数字；测哪位哪位就是1
              * JNZ L1；ZF = 0 时转L1
              * 判结果若就绪，进行数据传输，否则循环读状态字
          * 传输
            * 外设就绪后，寻址数据口
            * 输入：IN指令从数据端口读入数据
            * 输出：OUT指令想数据端口输出数据
  
    * 中断传送方式
  
      * 定义当外设输入/出数据准备好时，主动向CPU发中断请求使CPU中止当前程序的运行，转出执行外设传送数据的服务程序，进行数据的输入/出，传送完毕后，出CPU返回源程序的过程
      * 特点
        * 是一种效率较高的程序传送方式
        * 中断服务程序是预先设计好的
        * CPU在每条指令周期后采样中断请求输入信号
        * 外设需要传数据时，主动向CPU提出中断请求，提高实时性
        * 外设准备数据和CPU执行程序并行工作，提高了CPU效率
        * 每传输一次数据就要中断一次，需保护断点和现场
        * 需要中断控制器8259芯片
        * 适合少量数据、中慢速外设的数据传送

    * 中断工作方式
  
      * 中断请求：外设请求CPU进行数据传送
      * 中断响应
      * 响应条件：
        * CPU必须执行完当前的指令
        * CPU处于开中断
        * 不能有更高级的中断请求
      * 中断服务：使用中断服务子程序中IN OUT指进行数据的入/出
      * 中断返回：完成一次中断传送后返回原程序
      * 简述CPU与外部设备采用中断控制方式传输数据的过程
        * 当外部设备需要与CPU进行数据交换时，由接口部件8259芯片发出一个中断请求信号
        * CPU响应这一中断请求吗，便可在中断服务程序中完成一个字节或一个字的信息交换
        * 数据交换完成后，返回原程序
        * CPU每执行一次中断传送数据，要打断原来执行的程序去执行中断服务程序执行前要保护PSW和断点，执行后再恢复他们
  
    * DMA传送方式：
  
      * 不需要CPU介入由专门硬件DMAC（8237芯片）直接控制数据传送可以成块传送一批数据适用于高速外设与主存的直接传送
      * 特点
        * 克服程序控制传送的不足
        * 直接存储器存取DMA
        * DMA传送中，CPU释放总线，由DMA控制器（8237）管理
  
    * DMA传送原理
  
      * CPU对DMA控制器8235进行初始化设置
      * 外设、DMAC和CPU三者通过应答信号建立联系：CPU将总线交给DMAC控制
      * DMAC控制数据再内存和外设间传送
        * DMA读存储器：存储器-外设
        * DMA写存储器：存储器-外设
      * 自动增减地址和计数，判断传送完成否
      * 传送三阶段：传送前预处理-传送0传送后处理
      * DMA传送过程
        * 外设向DMAC发出请求
        * DMAC向CPU申请总线（hold）
        * CPU完成当前总线周期后响应（hlda），并释放总线控制权
        * DMAC得到总线 控制权，发出DMAC响应 信号
        * 由DMAC发出读写控制信号，控制外设与存储器之间的数据传送
        * 数据传送完后，DMAC撤销HOLD信号
        * CPU释放HLDA信号，并重新控制总线
      * 特点
      * 传送过程中不需要CPU，CPU效率高
      * 8237传送数据时，CPU执行自己的工作，两者完全并行
      * 8237没有总线，传送前/后需向CPU请求/归还总线
      * 高速外设、硬盘与内存之间用的就是这种传输方式
  
    * 总结
  
      * 无条件传送：吗，慢速外设需与CPU保持同步
  
      * 查询传送：简单实用，CPU效率较低

      * 中断传送：外设主动、实时性高，与CPU并行工作，CPU效率高，但每次传送需要大量额外时间
  
        开销，适于中慢速外设
  
      * DMA传送：传送过程中由专门的硬件DMAC控制，不需要CPU介入，外设直接和主存进行数据传送适合大量、快速数据传送
  
    * DMA区别的方式中断与方式
  
      * DMA方式是依靠硬件来实现存储器和外设之间的数据传送
      * 而中断方式是通过执行中断服务程序来实现数据传送
      * CPU对DMA的响应在指令执行的总线周期之后
      * 而中断方式的响应则是在执行完一条指令之后
      * DMA方式只能进行数据传送
      * 而中断方式不仅能进行数据传送，还能处理异常事件
      * DMA请求的优先权比中断请求高
      * DMA方式能进行数据块的传送，传输速度快
      * 而中断方式只能按字节进行传送，传输速度较慢
  
  